{"version":3,"sources":["module.android.ts"],"names":["RNP","NativeModules","RNPermissions","grantedToStatus","granted","RESULTS","GRANTED","DENIED","coreStatusToStatus","status","BLOCKED","UNAVAILABLE","openSettings","check","permission","available","includes","isNonRequestable","Core","request","rationale","setNonRequestable","splitByUsability","permissions","unusables","usables","blocklist","getNonRequestables","index","length","push","checkNotifications","checkMultiple","dedup","output","Promise","all","map","requestMultiple","toSetAsNonRequestable","statuses","hasOwnProperty","setNonRequestables","module","requestNotifications"],"mappings":"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","sourcesContent":["import {\n  NativeModules,\n  Permission as CorePermission,\n  PermissionsAndroid as Core,\n  PermissionStatus as CoreStatus,\n  Rationale,\n} from 'react-native';\nimport {RESULTS} from './constants';\nimport {Contract} from './contract';\nimport {NotificationsResponse, Permission, PermissionStatus} from './types';\nimport {uniq} from './utils';\n\nconst RNP: {\n  available: Permission[];\n\n  checkNotifications: () => Promise<NotificationsResponse>;\n  openSettings: () => Promise<true>;\n  getNonRequestables: () => Promise<Permission[]>;\n  isNonRequestable: (permission: Permission) => Promise<boolean>;\n  setNonRequestable: (permission: Permission) => Promise<true>;\n  setNonRequestables: (permissions: Permission[]) => Promise<true>;\n} = NativeModules.RNPermissions;\n\nfunction grantedToStatus(granted: boolean): PermissionStatus {\n  return granted ? RESULTS.GRANTED : RESULTS.DENIED;\n}\n\nfunction coreStatusToStatus(status: CoreStatus): PermissionStatus {\n  switch (status) {\n    case 'granted':\n      return RESULTS.GRANTED;\n    case 'denied':\n      return RESULTS.DENIED;\n    case 'never_ask_again':\n      return RESULTS.BLOCKED;\n    default:\n      return RESULTS.UNAVAILABLE;\n  }\n}\n\nasync function openSettings(): Promise<void> {\n  await RNP.openSettings();\n}\n\nasync function check(permission: Permission): Promise<PermissionStatus> {\n  if (!RNP.available.includes(permission)) {\n    return RESULTS.UNAVAILABLE;\n  }\n  if (await RNP.isNonRequestable(permission)) {\n    return RESULTS.BLOCKED;\n  }\n\n  const granted = await Core.check(permission as CorePermission);\n  return grantedToStatus(granted);\n}\n\nasync function request(\n  permission: Permission,\n  rationale?: Rationale,\n): Promise<PermissionStatus> {\n  if (!RNP.available.includes(permission)) {\n    return RESULTS.UNAVAILABLE;\n  }\n  if (await RNP.isNonRequestable(permission)) {\n    return RESULTS.BLOCKED;\n  }\n\n  const status = coreStatusToStatus(\n    await Core.request(permission as CorePermission, rationale),\n  );\n\n  if (status === RESULTS.BLOCKED) {\n    await RNP.setNonRequestable(permission);\n  }\n\n  return status;\n}\n\nasync function splitByUsability<P extends Permission[]>(\n  permissions: P,\n): Promise<{\n  unusables: Partial<Record<P[number], PermissionStatus>>;\n  usables: P[number][];\n}> {\n  const unusables: Partial<Record<P[number], PermissionStatus>> = {};\n  const usables: P[number][] = [];\n  const blocklist = await RNP.getNonRequestables();\n\n  for (let index = 0; index < permissions.length; index++) {\n    const permission: P[number] = permissions[index];\n\n    if (blocklist.includes(permission)) {\n      unusables[permission] = RESULTS.BLOCKED;\n      continue;\n    }\n    if (!RNP.available.includes(permission)) {\n      unusables[permission] = RESULTS.UNAVAILABLE;\n      continue;\n    }\n\n    usables.push(permission);\n  }\n\n  return {unusables, usables};\n}\n\nfunction checkNotifications(): Promise<NotificationsResponse> {\n  return RNP.checkNotifications();\n}\n\nasync function checkMultiple<P extends Permission[]>(\n  permissions: P,\n): Promise<Record<P[number], PermissionStatus>> {\n  const dedup = uniq(permissions);\n  const {unusables: output, usables} = await splitByUsability(dedup);\n\n  await Promise.all(\n    usables.map(async (permission: P[number]) => {\n      const granted = await Core.check(permission as CorePermission);\n      output[permission] = grantedToStatus(granted);\n    }),\n  );\n\n  return output as Record<P[number], PermissionStatus>;\n}\n\nasync function requestMultiple<P extends Permission[]>(\n  permissions: P,\n): Promise<Record<P[number], PermissionStatus>> {\n  const toSetAsNonRequestable: Permission[] = [];\n  const dedup = uniq(permissions);\n  const {unusables: output, usables} = await splitByUsability(dedup);\n  const statuses = await Core.requestMultiple(usables as CorePermission[]);\n\n  for (const permission in statuses) {\n    if (statuses.hasOwnProperty(permission)) {\n      const status = coreStatusToStatus(statuses[permission as CorePermission]);\n      output[permission as P[number]] = status;\n\n      status === RESULTS.BLOCKED &&\n        toSetAsNonRequestable.push(permission as Permission);\n    }\n  }\n\n  if (toSetAsNonRequestable.length > 0) {\n    await RNP.setNonRequestables(toSetAsNonRequestable);\n  }\n\n  return output as Record<P[number], PermissionStatus>;\n}\n\nexport const module: Contract = {\n  openSettings,\n  check,\n  request,\n  checkNotifications,\n  requestNotifications: checkNotifications,\n  checkMultiple,\n  requestMultiple,\n};\n"]}